name: build & release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os:
          - "ubuntu-latest"
          - "windows-latest"
          - "macos-latest"
        python:
          - "3.11"

    steps:
      - uses: actions/checkout@v4

      - name: Prepare dist
        run: |
          mkdir -p dist/${{ matrix.python }}-${{ matrix.os }}
          chmod -R 777 dist/${{ matrix.python }}-${{ matrix.os }}
      
      - name: Prepare Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      # ---------------------------
      # grammar (Rust + PyO3)
      # ---------------------------
      - name: Build grammar (manylinux)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        uses: PyO3/maturin-action@v1
        with:
          manylinux: "2014"
          args: >
            --release
            --strip
            -i /opt/python/cp311-cp311/bin/python
            --out ../dist/${{ matrix.python }}-${{ matrix.os }}
          working-directory: grammar

      - name: Build grammar (windows)
        if: ${{ matrix.os == 'windows-latest' }}
        run: |
          cd grammar
          pip install -U maturin
          maturin build --release --strip --out ../dist/${{ matrix.python }}-${{ matrix.os }}

      - name: Build grammar (macos)
        if: ${{ matrix.os == 'macos-latest' }}
        run: |
          cd grammar
          pip install -U maturin
          maturin build --release --strip --out ../dist/${{ matrix.python }}-${{ matrix.os }}

      # ---------------------------
      # hangul (uv)
      # ---------------------------
      - name: Build hangul
        run: |
          cd hangul
          pip install -U uv
          uv build --out-dir ../dist/${{ matrix.python }}-${{ matrix.os }}

      # ---------------------------
      # kulim (uv)
      # ---------------------------
      - name: Build kulim
        run: |
          cd kulim
          pip install -U uv
          uv build --out-dir ../dist/${{ matrix.python }}-${{ matrix.os }}

      # ---------------------------
      # Upload per-python artifacts
      # ---------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.python }}-${{ matrix.os }}
          path: dist/${{ matrix.python }}-${{ matrix.os }}/*

  release:
    runs-on: ${{ matrix.os }}
    needs: build

    strategy:
      fail-fast: false
      matrix:
        os:
          - "ubuntu-latest"
          - "windows-latest"
          - "macos-latest"

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-${{ matrix.python }}-${{ matrix.os }}

      - name: Flatten artifacts (manylinux)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: |
          mkdir final
          find dist-${{ matrix.python }}-${{ matrix.os }} -type f -exec cp {} final/ \;

      - name: Flatten artifacts (windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          mkdir final
          Get-ChildItem -Recurse -File -Path dist | ForEach-Object {
              Copy-Item $_.FullName -Destination final
          }

      - name: Flatten artifacts (macos)
        if: ${{ matrix.os == 'macos-latest' }}
        run: |
          mkdir final
          find dist-${{ matrix.python }}-${{ matrix.os }} -type f -exec cp {} final/ \;

      - name: Upload GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: final/*
          generate_release_notes: false
